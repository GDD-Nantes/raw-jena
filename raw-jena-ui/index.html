<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link href="./node_modules/@triply/yasgui/build/yasgui.min.css" rel="stylesheet" type="text/css" />
    <link href="./css/style.css" rel="stylesheet" />
    <script src="./node_modules/@triply/yasgui/build/yasgui.min.js"></script>
    <script src="./node_modules/d3/dist/d3.min.js"></script>
    <script type="module" src="./src/PAYGQuery.js"></script>
    <script type="module" src="./src/RAWPlugin.js"></script>
    <script type="module" src="./src/PlanView.js"></script>
  </head>
  
  <body>
    <div class="header">
      <span class="logo">R.A.W</span>
      <span class="github">
        <a href="https://github.com/Chat-Wane/raw-jena">
        <img src="./res/github-mark.svg"
             alt="GitHub repository of RAW"
             height="30px"
             width="30px" />
        </a>
      </span>
    </div>
    
    <div id="yasgui"></div>

    <footer class="footer">
      <p class="text-center">
        Ⓒ 2017–2023
        <a href="https://sites.google.com/site/gddlina/">GDD Team</a>,
        <a href="https://www.ls2n.fr?lang=en">LS2N</a>,
        <a href="http://www.univ-nantes.fr/">University of Nantes</a>
      </p>
    </footer>

    
    <script type="module">
      /// import {PAYGQuery} from "./PAYGQuery";
      import {RAWPlugin} from "./src/RAWPlugin";
      import {PAYGQuery} from "./src/PAYGQuery";
      // registering of plugins must be done before Yasgui() ofc.
      Yasr.registerPlugin("RAW", RAWPlugin);
      
      const yasgui = new Yasgui(document.getElementById("yasgui"), {
          requestConfig: {
              endpoint: "http://localhost:8080/watdiv10M",
              // (TODO) make sure these are recognized by the server
              // (TODO) if they do not exist, should run the query normally
              args: [{name:"limit", value:"100"},
                     {name:"timeout", value:"1000"}],
          },
          copyEndpointOnNewTab: false,
      })

      const yasqe = yasgui.getTab().yasqe;
      const yasr  = yasgui.getTab().yasr;

      var paygQuery = new PAYGQuery(yasqe.getValue());
      
      yasqe.on("query", (instance, req) => {
          var newPaygQuery = new PAYGQuery(yasqe.getValue());
          if (!newPaygQuery.equals(paygQuery)) {
              paygQuery = newPaygQuery;
          }
      });

      // (TODO) put an identifier in the query.
      yasqe.on("queryResponse", (instance, resp, duration) => {
          // (TODO) check if everything HTTP code
          var data = JSON.parse(resp.text);
          var bindings = data.results.bindings;
          paygQuery.addDuration(duration);
          paygQuery.addBindings(bindings);
          console.log(data);
          // paygQuery.addRAWAggregated(data.RAWOutputAggregated);
          resp.body.results.bindings = paygQuery.bindings; // ugly
          // resp.body.RAWOutputAggregated.node2cardinality = paygQuery.node2cardinality; // ugly
          // resp.body.RAWOutputAggregated.node2nbWalks = paygQuery.node2nbWalks; // ugly
          paygQuery.updatePlan(data.RAWOutput.plan);
        
          yasr.setResponse(resp, paygQuery.totalDuration)
      });

      // monkey-patch the response informations label
      const updateResponseInfo = yasr.updateResponseInfo;
      yasr.updateResponseInfo = function() {
          yasr.results.bindings = paygQuery.bindings
          updateResponseInfo.call(yasr)
          yasr.dataElement.innerText += " (" + paygQuery.nbTimes + " pause/resume)"
      };
      
    </script>
  </body>

</html>
